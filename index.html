<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Player Plus</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  <style>
    body,html {margin:0;padding:0;background:#000;height:100%;width:100%;overflow:hidden;}
    video {width:100%;height:100%;background:#000;object-fit:contain;}
    .shaka-video-container {width:100%;height:100%;}
  </style>
</head>
<body>
  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline></video>
  </div>

  <script>
    const playlistUrl = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";
    const query = new URLSearchParams(window.location.search);
    const channelId = query.get("id"); // tvg-id থেকে ম্যাচ হবে

    async function parseM3U(url) {
      const text = await fetch(url).then(r => r.text());
      const channels = [];
      const lines = text.split("\n");
      let current = {};

      for (let line of lines) {
        line = line.trim();
        if (line.startsWith("#EXTINF:")) {
          const matchId = line.match(/tvg-id="([^"]+)"/);
          const logo = line.match(/tvg-logo="([^"]+)"/);
          const name = line.split(",").pop().trim();
          current = { id: matchId ? matchId[1] : null, logo: logo ? logo[1] : "", name };
        } else if (line.startsWith("#KODIPROP:inputstream.adaptive.license_key")) {
          const keyParts = line.split("=")[1].split(":");
          current.keyId = keyParts[0];
          current.key = keyParts[1];
        } else if (line.startsWith("#EXTVLCOPT:http-user-agent")) {
          current.userAgent = line.split("=")[1];
        } else if (line.startsWith("#EXTHTTP:")) {
          try { current.cookie = JSON.parse(line.replace("#EXTHTTP:", "")); } catch {}
        } else if (line.startsWith("http")) {
          current.url = line;
          channels.push(current);
          current = {};
        }
      }
      return channels;
    }

    async function init() {
      const list = await parseM3U(playlistUrl);
      const ch = list.find(c => c.id === channelId);
      if (!ch) {
        alert("Channel not found!");
        return;
      }

      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        alert("Browser not supported!");
        return;
      }

      const video = document.querySelector("video");
      const player = new shaka.Player(video);
      const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);

      player.configure({
        drm: { clearKeys: { [ch.keyId]: ch.key } },
        streaming: { lowLatencyMode: true },
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if (ch.userAgent) request.headers["User-Agent"] = ch.userAgent;
        request.headers["Referer"] = "https://www.jiotv.com/";
        if (ch.cookie?.cookie) request.headers["Cookie"] = ch.cookie.cookie;
      });

      try {
        await player.load(ch.url);
        console.log("Playing:", ch.name);
      } catch (e) {
        console.error("Playback error:", e);
      }
    }

    init();
  </script>
</body>
</html>
