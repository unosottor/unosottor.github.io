<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    .shaka-video-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="shaka-video-container" data-shaka-player>
    <video autoplay playsinline></video>
  </div>

  <script>
    async function parseM3UAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");
      if (!id) return alert("‚ùå No id provided!");

      // ‚úÖ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶á‡¶® M3U playlist URL
      const m3uUrl = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u"; 

      const response = await fetch(m3uUrl);
      const text = await response.text();

      // üîç ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ID ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßá‡¶ó‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
      const regex = new RegExp(`#EXTINF:[^#]*tvg-id="${id}"[\\s\\S]*?(https[^\n]+)`, "m");
      const match = text.match(regex);
      if (!match) return alert("‚ùå Channel not found!");

      const block = match[0];
      const mpdUrl = block.match(/(https[^\s]+)/)[1];
      const keyMatch = block.match(/#KODIPROP:inputstream\.adaptive\.license_key=(.*)/);
      const uaMatch = block.match(/#EXTVLCOPT:http-user-agent=(.*)/);
      const cookieMatch = block.match(/#EXTHTTP:\{"cookie":"(.*)"\}/);

      const keyId = keyMatch ? keyMatch[1].split(":")[0].trim() : "";
      const key = keyMatch ? keyMatch[1].split(":")[1].trim() : "";
      const userAgent = uaMatch ? uaMatch[1].trim() : "";
      const cookie = cookieMatch ? cookieMatch[1].trim() : "";

      console.log("üéØ MPD:", mpdUrl);
      console.log("üóùÔ∏è Key:", keyId, key);
      console.log("üß† UA:", userAgent);
      console.log("üç™ Cookie:", cookie);

      const video = document.querySelector("video");
      const player = new shaka.Player(video);

      player.configure({
        drm: { clearKeys: { [keyId]: key } },
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers["Referer"] = "https://www.jiotv.com/";
        if (userAgent) request.headers["User-Agent"] = userAgent;
        if (cookie) request.headers["Cookie"] = cookie;
      });

      try {
        await player.load(mpdUrl);
        console.log("‚úÖ Playing...");
      } catch (e) {
        console.error("Playback Error:", e);
        alert("‚ö†Ô∏è Playback Error: " + e.code);
      }
    }

    document.addEventListener("DOMContentLoaded", parseM3UAndPlay);
  </script>
</body>
</html>
