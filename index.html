<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" />
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: #101010;
      border-bottom: 1px solid #222;
    }
    header img {
      height: 40px;
      border-radius: 8px;
    }
    header h1 {
      font-size: 1.1rem;
      font-weight: 500;
    }
    #video-container {
      position: relative;
      width: 100%;
      max-width: 960px;
      margin: 10px auto;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
    }
    #loading {
      color: #ccc;
      font-size: 1.1rem;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header id="header"></header>
  <div id="video-container">
    <video id="video" autoplay controls></video>
  </div>
  <div id="loading">⏳ Loading stream...</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const playlistURL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

    if (!id) {
      document.getElementById("loading").innerText = "❌ No ID provided!";
      throw new Error("Missing ?id=");
    }

    async function fetchPlaylist() {
      const text = await fetch(playlistURL).then(r => r.text());
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      let idx = -1;

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes(`tvg-id="${id}"`)) {
          idx = i;
          break;
        }
      }

      if (idx === -1) throw new Error("Channel not found in playlist!");

      const info = lines[idx];
      const keyLine = lines[idx + 1];
      const uaLine = lines[idx + 2];
      const cookieLine = lines[idx + 3];
      const urlLine = lines[idx + 4];

      const name = info.split(",")[1]?.trim();
      const logo = (info.match(/tvg-logo="(.*?)"/) || [])[1];
      const group = (info.match(/group-title="(.*?)"/) || [])[1];

      // Extract clearkey pair
      const keyPair = keyLine.split("=").pop().trim();
      const [keyId, key] = keyPair.split(":");

      // Extract UA and Cookie
      const userAgent = uaLine.split("=")[1]?.trim();
      const cookie = cookieLine.replace("#EXTHTTP:", "").trim();
      const manifestUri = urlLine.trim();

      return { id, name, logo, group, keyId, key, userAgent, cookie, manifestUri };
    }

    async function initPlayer() {
      try {
        const ch = await fetchPlaylist();
        document.getElementById("loading").remove();

        document.getElementById("header").innerHTML = `
          <img src="${ch.logo}" alt="logo">
          <h1>${ch.name}</h1>
        `;

        const video = document.getElementById("video");
        const player = new shaka.Player(video);

        player.getNetworkingEngine().registerRequestFilter((type, request) => {
          if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
              type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
            if (ch.userAgent) request.headers["User-Agent"] = ch.userAgent;
            if (ch.cookie) request.headers["Cookie"] = ch.cookie;
          }
        });

        player.configure({
          drm: { clearKeys: { [ch.keyId]: ch.key } }
        });

        await player.load(ch.manifestUri);
        console.log("✅ Playing:", ch.name);
      } catch (err) {
        document.getElementById("loading").innerText = "❌ Failed: " + err.message;
        console.error(err);
      }
    }

    document.addEventListener("DOMContentLoaded", initPlayer);
  </script>
</body>
</html>
